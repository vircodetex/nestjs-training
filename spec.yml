name: vm-nestjs-app
region: lon

alerts:
  - rule: DEPLOYMENT_FAILED
  - rule: DOMAIN_FAILED

features:
  - buildpack-stack=ubuntu-22

databases:
  - engine: PG
    name: db
    version: "14"

envs:
  - key: APP_MESSAGE_PREFIX
    scope: RUN_AND_BUILD_TIME
    value: "\U0001F680"
  - key: DB_HOST
    scope: RUN_AND_BUILD_TIME
    value: ${db.HOSTNAME}
  - key: DB_PORT
    scope: RUN_AND_BUILD_TIME
    value: ${db.PORT}
  - key: DB_USER
    scope: RUN_AND_BUILD_TIME
    value: ${db.USERNAME}
  - key: DB_PASSWORD
    scope: RUN_AND_BUILD_TIME
    value: ${db.PASSWORD}
  - key: DB_DATABASE
    scope: RUN_AND_BUILD_TIME
    value: ${db.DATABASE}
  - key: DB_SYNC
    scope: RUN_AND_BUILD_TIME
    value: "false"
  - key: JWT_SECRET
    scope: RUN_AND_BUILD_TIME
    value: 60b76bf95c161a762d5dba5c42b3501560b4fb271335db4c972ecf1ef2cfa71f
  - key: JWT_EXPIRES_IN
    scope: RUN_AND_BUILD_TIME
    value: 60m
  - key: DATABASE_URL
    scope: RUN_AND_BUILD_TIME
    value: ${db.DATABASE_URL}
  - key: DB_SSL
    scope: RUN_AND_BUILD_TIME
    value: "true"
  - key: NODE_ENV
    scope: RUN_AND_BUILD_TIME
    value: production
  - key: VITE_API_URL
    scope: RUN_AND_BUILD_TIME
    value: https://vm-nestjs-app-k6afx.ondigitalocean.app
  - key: VITE_API_PORT
    scope: RUN_AND_BUILD_TIME
    value: "3000"

ingress:
  rules:
    - component:
        name: frontend
      match:
        authority:
          exact: ""
        path:
          prefix: /
    - component:
        name: backend
      match:
        authority:
          exact: ""
        path:
          prefix: /api

services:
  - name: backend
    dockerfile_path: backend/Dockerfile
    github:
      branch: master
      deploy_on_push: true
      repo: vircodetex/nestjs-training
    source_dir: backend
    http_port: 3000
    instance_count: 1
    instance_size_slug: apps-s-1vcpu-0.5gb
    routes:
      - path: /api(/.*)?
        preserve_path: true

  - name: frontend
    git:
      branch: master
    source_dir: frontend
    build_command: npm install && npm run build
    run_command: npm run preview
    http_port: 4173
    routes:
      - path: /
        preserve_path: true
